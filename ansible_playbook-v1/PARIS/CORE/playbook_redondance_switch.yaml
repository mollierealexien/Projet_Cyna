---
- name: Configurer les switches SW1 et SW2 pour LACP avec pfSense
  hosts: SWITCHES
  gather_facts: no
  vars:
    vlans:
      - { id: 10, name: "Admin_Reseau" }
      - { id: 20, name: "Utilisateurs" }
      - { id: 40, name: "Serveurs" }
    trunk_vlans: "10,20,40"
    etherchannel_id: "{{ (inventory_hostname == 'SW1-PAR-CORE') | ternary('1', '2') }}"
    spanning_priority: "{{ (inventory_hostname == 'SW1-PAR-CORE') | ternary('4096', '8192') }}"
    port_channel_name: "Port-channel{{ etherchannel_id }}"
    pfSense_interface: "GigabitEthernet0/0"

  tasks:

  - name: Créer les VLANs
    vars:
      vlan_lines: |
        {% set l = [] %}
        {% for vlan in vlans %}
        {%   set _ = l.append('vlan ' ~ vlan.id) %}
        {%   set _ = l.append(' name ' ~ vlan.name) %}
        {% endfor %}
        {{ l }}
    ios_config:
      lines: "{{ vlan_lines }}"

  - name: Configurer le port trunk vers pfSense
    ios_config:
      parents:
        - interface {{ pfSense_interface }}
      lines:
        - description Trunk vers pfSense
        - switchport trunk encapsulation dot1q
        - switchport mode trunk
        - switchport trunk allowed vlan {{ trunk_vlans }}
        - no shutdown

  - name: Pause pour laisser monter l’interface pfSense
    pause:
      seconds: 5

  - name: Appliquer le channel-group (LACP)
    ios_config:
      parents:
        - interface {{ pfSense_interface }}
      lines:
        - channel-group {{ etherchannel_id }} mode active

  - name: Configurer l’EtherChannel
    ios_config:
      parents:
        - interface {{ port_channel_name }}
      lines:
        - description Aggregated trunk to pfSense
        - switchport trunk encapsulation dot1q
        - switchport mode trunk
        - switchport trunk allowed vlan {{ trunk_vlans }}
        - no shutdown

  - name: Configurer le lien inter-switch (Gi3/3)
    ios_config:
      parents:
        - interface GigabitEthernet3/3
      lines:
        - description Trunk vers autre switch coeur
        - switchport trunk encapsulation dot1q
        - switchport mode trunk
        - switchport trunk allowed vlan {{ trunk_vlans }}
        - no shutdown

  - name: Configurer le mode STP
    ios_config:
      lines:
        - spanning-tree mode pvst

  - name: Configurer priorité VLAN 10
    ios_config:
      lines:
        - spanning-tree vlan 10 priority {{ spanning_priority }}

  - name: Configurer priorité VLAN 20
    ios_config:
      lines:
        - spanning-tree vlan 20 priority {{ spanning_priority }}

  - name: Configurer priorité VLAN 40
    ios_config:
      lines:
        - spanning-tree vlan 40 priority {{ spanning_priority }}

  - name: Configurer les trunks vers les switches de distribution
    ios_config:
      lines:
        - interface range GigabitEthernet1/0 - 3 , GigabitEthernet2/0 - 3
        - description Trunks vers switches de distribution
        - switchport trunk encapsulation dot1q
        - switchport mode trunk
        - switchport trunk allowed vlan {{ trunk_vlans }}
        - no shutdown
